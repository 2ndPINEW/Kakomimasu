<!DOCTYPE html>
<html lang="ja">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="serverUtil.js"></script>
        <title>ルーム詳細 : Kakomimasu</title>
    </head>

    <body>
        <div style="width: 100%; text-align: center;">
            <img id="rogo-img" height="70px" src="./img/kakomimasu-logo.png" alt="Kakomimasuロゴ">
            <h1>ルーム詳細</h1>
        </div>
        <div>
            <h4 id="room-id"></h4>
            <h4 id="now-time"></h4>
            <table id="room-table">
                <tr>
                    <th>ルームID</th>
                    <th>ステータス</th>
                    <th>開始予定時刻</th>
                </tr>
            </table>
        </div>
        <div style="margin-top: 10px; text-align: center;">
            <h3>フィールドの様子</h3>
            <div style="margin: auto;display: inline-block;">
                <div style="position:relative;height: 30px;">
                    <h4 id="field-turn"></h4>
                    <h4 id="field-point"><span class="p1">0</span>：<span class="p2">0</span></h4>
                    <h4 id="field-nextTurnTime">ゲーム開始までお待ちください...</h4>
                </div>
                <table id="field-table"></table>
            </div>
        </div>
        <script language="javascript" type="text/javascript">
            nowTimeDisp();
            setInterval('nowTimeDisp()', 1000);
            getRoomInfo();
            setInterval("getRoomInfo()", 100);

            async function getRoomInfo() {
                const roomid = document.URL.match(new RegExp("([^/]+?)?.info$"))[1];
                //console.log(roomid);
                const reqUrl = `${getRootURL()}/match/${roomid}`;
                const roomJson = await (await fetch(reqUrl)).json();
                console.log(roomJson);
                const roomData = [];

                //let linkedRoomid = `<a href=${getRootURL()}/match/${room.roomID}.info>`;
                let [status, startTime] = getGameStatus(roomJson);
                //let startTime = "";

                roomData.push([
                    roomJson.roomID,//linkedRoomid,//room.roomID,
                    status,
                    startTime,
                ]);


                const table = document.getElementById("room-table");
                //table.innerHTML = "";
                roomData.forEach((data, i) => {
                    let tr;
                    let trElements = table.getElementsByClassName("room-" + i);
                    if (trElements.length > 0) tr = trElements[0];
                    else {
                        tr = document.createElement("tr");
                        tr.classList.add("room-" + i);
                        table.appendChild(tr);
                    }
                    data.forEach((element, j) => {
                        let td;
                        let tdElements = tr.getElementsByClassName("roomdata-" + j);
                        if (tdElements.length > 0) td = tdElements[0];
                        else {
                            td = document.createElement("td");
                            td.classList.add("roomdata-" + j);
                            tr.appendChild(td);
                        }
                        td.textContent = element;
                    });
                });

                // フィールド更新
                if (roomJson.startedAtUnixTime === null) {
                }
                else {
                    document.getElementById("field-turn").textContent = getTurnText(roomJson);
                    document.getElementById("field-point").getElementsByClassName("p1")[0].textContent = parseInt(roomJson.players[0].point.basepoint) + parseInt(roomJson.players[0].point.wallpoint);
                    document.getElementById("field-point").getElementsByClassName("p2")[0].textContent = roomJson.players[1].point.basepoint + roomJson.players[1].point.wallpoint;
                    let statusText = "";
                    if (nowUnixTime() < roomJson.startedAtUnixTime) statusText = `ゲーム開始まで${roomJson.startedAtUnixTime - nowUnixTime()}秒`;
                    else if (nowUnixTime() < roomJson.nextTurnUnixTime) statusText = `次のターンまで${roomJson.nextTurnUnixTime - nowUnixTime()}秒`;
                    else if (!roomJson.ending) statusText = "競合チェック中...";
                    else statusText = "ゲーム終了";
                    document.getElementById("field-nextTurnTime").textContent = statusText;

                    const fieldTable = document.getElementById("field-table");
                    for (let y = 0; y < roomJson.height; y++) {
                        let tr;
                        let trElements = fieldTable.getElementsByClassName(`fieldY-${y}`);
                        if (trElements.length > 0) tr = trElements[0];
                        else {
                            tr = document.createElement("tr");
                            tr.classList.add(`fieldY-${y}`);
                            fieldTable.appendChild(tr);
                        }
                        for (let x = 0; x < roomJson.width; x++) {
                            let td;
                            let tdElements = tr.getElementsByClassName(`fieldX-${x}`);
                            if (tdElements.length > 0) td = tdElements[0];
                            else {
                                td = document.createElement("td");
                                //td.classList.add(`fieldX-${x}`);
                                tr.appendChild(td);
                            }
                            td.textContent = roomJson.points[x + y * roomJson.width];
                            let className = `fieldX-${x} `;
                            let playerid = roomJson.tiled[x + y * roomJson.width][1];
                            if (playerid !== -1) {
                                if (roomJson.tiled[x + y * roomJson.width][0] === 1) className += `p${playerid + 1}Wall`;
                                if (roomJson.tiled[x + y * roomJson.width][0] === 0) className += `p${playerid + 1}Area`;
                                roomJson.players.forEach((p, i) => {
                                    p.agents.forEach(a => {
                                        if (a.x >= 0 && a.x === x && a.y >= 0 && a.y === y) className += " agent";
                                    });
                                });
                            }
                            td.classList = className;
                            //if ()
                        }

                    }
                }
            }

            function nowTimeDisp() {
                var now = new Date();
                document.getElementById("now-time").innerHTML = "現在時刻：" + now.toLocaleString("ja-JP");
            }

        </script>

    </body>

</html>

<style>
    table,
    td,
    th {
        border: 1px solid;
        border-collapse: collapse;
        text-align: center;
    }

    table {
        margin: 0 auto;
    }

    th,
    td {
        padding: 5px;
    }

    #field-table td {
        width: 50px;
        height: 50px;
        text-align: right;
        vertical-align: bottom;
    }

    #field-turn,
    #field-point,
    #field-nextTurnTime {
        position: absolute;
        margin: 0;
        bottom: 0;
        width: 100%;
    }

    #field-turn {
        text-align: left;
    }

    #field-point {
        text-align: center;
    }

    #field-nextTurnTime {
        text-align: right;
    }

    #now-time {
        text-align: center;
    }

    .p1 {
        color: blue;
    }

    .p2 {
        color: red;
    }

    td.agent {
        background-image: url(.img/agent.png);
        background-size: 80%;
        background-position: 0%, 50%;
        background-repeat: no-repeat;
    }

    td.p1Wall {
        background-color: #0096FF;
    }

    td.p2Wall {
        background-color: #FF0200;
    }

    td.p1Area {
        background-color: #80C9FF;
    }

    td.p2Area {
        background-color: #FE9998;
    }
</style>